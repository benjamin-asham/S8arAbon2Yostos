<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุฌุฏูู ุงูููุงุท - ููุญุฉ ุงูุชุญูู</title>
  <link rel="shortcut icon" href="/imgs/Christian favicon.jpeg" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Arabic:wght@100..800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { font-family: "Playpen Sans Arabic", cursive; }
    .score { min-width: 30px; display: inline-block; text-align: center; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg mt-3 p-0" style="background-color:#FEB21A;">
    <div class="container">
      <a class="navbar-brand fs-3" href="index.html">
        <i class="fa-solid fa-church"></i>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link text-light active" href="index.html">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="index.html#alMosab2">ูุณุงุจูุฉ ุงูุฃุณุฑุฉ</a></li>
          <li class="nav-item"><a class="nav-link text-light" href="index.html#about">ุนู ุงูุฃุณุฑุฉ</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container my-5" style="color:#0d335e;">
    <h2 class="text-center mb-4">ููุญุฉ ุงูุชุญูู - ุชุนุฏูู ููุงุท ุงูุฃููุงุฏ</h2>

    <table id="boysTable" class="table table-striped table-bordered shadow">
      <thead class="table-warning">
        <tr>
          <th>ุงูุชุฑุชูุจ</th>
          <th>ุงูุงุณู</th>
          <th class="text-center">ุงูููุงุท</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Footer -->
    <footer class="text-center py-3 mt-5" style="background-color:#FEB21A; color:#fff;">
      <p class="mb-0 fs-6">
        &copy; 2025 ุฃุณุฑุฉ ุฃุจููุง ูุณุทุณ ุงูุฃูุทููู ูุงููุฏูุณ ููุณู ุงูุตุฏูู - ูููุณุฉ ุงูุดููุฏ ุงูุนุธูู ูุงุฑุฌุฑุฌุณ
        <br> by | eng | Benjamin
      </p>
    </footer>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

    // ----------------- ููุน ุงูุฏุฎูู ุจุฏูู ุชุณุฌูู
    if (!localStorage.getItem("loggedIn")) {
      window.location.href = "login.html";
    }

    // ----------------- ุฅุนุฏุงุฏ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCNj0P9AgNazzEN86oLrMo0hzMg6E34R6U",
      authDomain: "benjaminasham-9c7d2.firebaseapp.com",
      projectId: "benjaminasham-9c7d2",
      storageBucket: "benjaminasham-9c7d2.appspot.com",
      messagingSenderId: "182864629177",
      appId: "1:182864629177:web:65e67ae295ecdb6b84ba68",
      measurementId: "G-8RHE4H5JYV"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ----------------- ุฃุณูุงุก ุงูุฃููุงุฏ
    const boys = [
      "ุจุงุณูุชูุฑ ุณุงูุญ","ุฑูุจู ุฑุงูู","ุฑูุฌูู ูุดุงุช","ุฑูุฌูู ุฌูุฑุฌ","ููุฑูุณ ุฑูุณูุณ","ุงููุงู ูุงูู",
      "ูุงูู ุงููู","ูุงุฑู ุงููุงุจ","ูุงุฑุชู ูุงุฑูู","ูุงุซูู ูููุง","ูุงุซูู ุญูุง","ูููุง ุดููุฏุฉ",
      "ูููุง ุนูุงุฏ","ูุงุฑุงุณ ุจุณุงู","ููููุจุชูุฑ ูููุง","ูุณู ูุณูู","ุจูุดูู ุฏููุงู","ุงุฏู ูุงุฌู","test"
    ];
    boys.sort((a, b) => a.localeCompare(b, 'ar'));

    const tableBody = document.querySelector("#boysTable tbody");

    // ----------------- ุชุญููู ูุชุญุฏูุซ ุงูููุงุท Live
    function loadScoresRealtime() {
      onSnapshot(collection(db, "quiz_scores"), (snapshot) => {
        const scoresMap = {};
        snapshot.forEach(d => {
          const data = d.data();
          scoresMap[data.name] = { score: data.score || 0, resetAt: data.resetAt || null };
        });

        tableBody.innerHTML = "";
        boys.forEach((name, index) => {
          const score = scoresMap[name]?.score || 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${name}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-success me-2 plus">+</button>
              <span class="score fw-bold">${score}</span>
              <button class="btn btn-sm btn-danger ms-2 minus">-</button>
              <button class="btn btn-sm btn-warning ms-2 reset">๐</button>
            </td>
          `;
          tableBody.appendChild(tr);

          // ุฒุฑ +
          tr.querySelector(".plus").addEventListener("click", async () => {
            const newScore = score + 1;
            await setDoc(doc(db, "quiz_scores", name), { name, score: newScore }, { merge: true });
          });

          // ุฒุฑ -
          tr.querySelector(".minus").addEventListener("click", async () => {
            const newScore = Math.max(score - 1, 0);
            await setDoc(doc(db, "quiz_scores", name), { name, score: newScore }, { merge: true });
          });

          // ุฒุฑ Reset
          tr.querySelector(".reset").addEventListener("click", async () => {
            const confirmReset = confirm(`ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุถุจุท ${name} ููุจุฏุฃ ุงูุนุฏ ูู ุฌุฏูุฏุ`);
            if (!confirmReset) return;

            const resetTime = new Date().toISOString(); // ูุญุธุฉ ุงูุฑูุณูุช
            await setDoc(doc(db, "quiz_scores", name), { 
              name, 
              score: score, 
              resetAt: resetTime 
            }, { merge: true });

            alert(`${name} ุชู ุฅุนุงุฏุฉ ุถุจุทู. ุณูุจุฏุฃ ุงูุนุฏ ูู ุฌุฏูุฏ ูู ุงูุขู โ`);
          });
        });
      });
    }

    document.addEventListener("DOMContentLoaded", loadScoresRealtime);

    // ----------------- ุฏุงูุฉ ููุชุญูู ูู ุงูููุฏ ูุณููุญ ููุนุจ ููุง ูุฃ
    async function canPlay(studentName) {
      const ref = doc(db, "quiz_scores", studentName);
      const snap = await getDoc(ref);
      if (!snap.exists()) return true;

      const data = snap.data();
      const resetAt = data.resetAt ? new Date(data.resetAt) : null;
      const now = new Date();

      if (!resetAt) return true; // ูู ูุณู ูุชุนูููุด reset

      const diffDays = (now - resetAt) / (1000 * 60 * 60 * 24);
      return diffDays >= 7; // ูุณููุญ ููุนุจ ุจุนุฏ 7 ุฃูุงู ูู ุขุฎุฑ Reset
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
